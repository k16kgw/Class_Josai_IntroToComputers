# 順序回路の設計法

到達目標
- 順序回路の**設計手順**（状態遷移図→2進コード化→遷移表→論理式）を一通り実施できる．
- **カウンタ**と**レジスタ**の基本構成を理解できる．

今日の問い
- 図で描いた状態機械をどのように回路へ実装するのか？

キーワード
- 状態遷移図，2進コード化，状態遷移表
- カウンタ
- レジスタ

## 順序回路

- **順序回路**：初期状態から始まり，決まった順序で状態遷移を行う機能を実現する回路．
<!-- - **順序回路**：出力が**現在の入力**だけでなく**内部状態**にも依存して決まる回路． -->
  
  <!-- 形式：$Q^+ = f(Q, X)$, $Y = g(Q, X)$（Mealy）／ $Y = g(Q)$（Moore） -->

- **状態遷移図**：状態ノードと，入力条件付きの矢印（次状態）で表す．

## 順序回路の設計

1. **状態遷移図の作成**：初期状態と終了状態を含む<u>複数の状態を定義</u>し，次に各状態への入力とそれにより生じる状態遷移と出力を定義する．
2. **2進コード化**：各状態と入出力を表する2進数の値を決め，1で作成した状態遷移図を2進数の値で描き直す．
3. **状態遷移表の作成**：現在の状態から入力により次の状態へ遷移し，出力する様子を状態遷移表にまとめる．
4. **回路化**：状態遷移表に従い，状態遷移図と同様の動作を行う順序回路を，フリップフロップと組合せ回路を用いて設計する．

### 例：3枚入れるとコーヒーが出る自動販売機

1種類の硬貨のみを考え，硬貨を3枚入れるとコーヒーが出てくる自動販売機を実装する．

**Step 1：状態遷移図の作成**

![状態遷移図](/contents/figs/9/state_graph.png)

**Step 2：2進コード化**

- 入力：硬貨を投入する/しない → 1,0
- 出力：コーヒーを出す/出さない → 1,0
- 現在の状態：硬貨の枚数0,1,2枚 → 00,01,10

![2進コード化](/contents/figs/9/bit_graph.png)

**Step 3：状態遷移表の作成**

![状態遷移表](/contents/figs/9/state_table.png)

**Step 4：回路化**

- 入力：硬貨を投入する/しない(1,0) → $S$, 1bit
- 出力：コーヒーを出す/出さない(1,0) → $G$, 1bit
- 現在の状態：硬貨の枚数0,1,2枚(00,01,10) → $C_1, C_0$の2bit

  ※ 現在の状態は記憶されないといけない．

- 次の状態：硬貨の枚数0,1,2枚(00,01,10) → $N_1, N_0$の2bit
- 状態の(11)は使用されていないため，ドントケアとして扱える．

- $N_1$のカルノー図は

  ![Karnaugh](/contents/figs/9/Karnaugh_N1.png)

  となるから

  $$
  N_1 = C_1 \cdot \overline{S} + C_0 \cdot S
  $$

```{note}
**演習1**

1. $N_0$のカルノー図を作成し，$N_0$を加法標準形で表せ．
2. $G$のカルノー図を作成し，$G$を加法標準形で表せ．


![Karnaugh](/contents/figs/9/Karnaugh_N0.png)

$$
N_0 = C_0 \cdot \overline{S} + \overline{C_0} \cdot \overline{C_1} \cdot S
$$

![Karnaugh](/contents/figs/9/Karnaugh_G.png)

$$
G = C_1 \cdot S
$$

```

従って，整理すれば

$$
& G = C_1 \cdot S
\\
& N_0 = C_0 \cdot \overline{S} + \overline{C_0} \cdot \overline{C_1} \cdot S
\\
& N_1 = C_1 \cdot \overline{S} + C_0 \cdot S
$$

現在の状態$C_0, C_1$はクロックが0($CLK=0$)の間は保持している必要があるが，クロックが1になったとき($CLK=1$)は次の状態$N_0, N_1$で上書きする必要があるため，これはDフリップフロップで構成する．

![回路](/contents/figs/11/vending_circuit.png)


<!-- 
4. 回路の設計（論理式の決定）

   - (Q^+) と (Y) を **K-map** や **Q–M法**で簡略化し，**D-FF／JK-FF／T-FF** いずれかで実装する．
   - FFをJK/Tで用いるなら**励起表**で入力式を導出（例：Tは「変えたいとき1」）．
 -->

<!-- 
### 回路の構成（最小ブロック）

- 記憶：D-FF（一般的），またはJK/T-FF（カウンタ等）を**状態ビット数だけ**用意．
- 組合せ回路：

  - 次状態方程式 (Q^+ = f(Q, X))
  - 出力方程式 (Y = g(Q))（Moore）または (g(Q, X))（Mealy）
- リセット（初期化）：

  - 同期リセット（CLKで反映）／非同期リセット（即反映）．FPGA/ASICで流儀が異なるため**方針を統一**する．
- クロック：

  - 1ドメイン内で配線（スキュー最小化），非同期入力は**2段同期器**で取り込み（第9回復習）．
 -->
### 現実の回路における問題点

- タイミング制約
  - コインが投入されたとき($S=1$)，クロックが1($CLK=1$)でないと投入は判定されない．
  - コインが投入されたとき($S=1$)，クロックが速く($CLK=1\to0\to1$)となると，コインは1度しか投入されていないにも関わらず2度投入された判定をされてしまう．

→ クロックは速すぎても遅すぎても所定の動作をしない．

## カウンタ

回路に入力された信号の個数を数える回路．周波数の安定した入力の波（パルス）を与えることで時計やタイマーを構成することが可能となる．

種類
- 基準のクロックに
  - 同期させない→非同期カウンタ
  - 同期させる→同期カウンタ
- カウント法
  - 昇順（0,1,2,…）→アップカウンタ
  - 降順（5,4,3,…）→ダウンカウンタ
  - 昇順・降順どちらも可能→アップダウンカウンタ

### $2^N$進カウンタ

クロックが下がったタイミングで数え上げるように設計する．

![タイミングチャート](/contents/figs/11/counter.png)

![カウンタ回路図](/contents/figs/11/counter_circuit.png)

```{note}
**演習2**  

上述の$2^N$進カウンタでは$7$から$0$に戻る際に誤作動を起こす可能性がある．
具体的には$7$から$0$になるまでの間に他の数値を示す．
ここで示される他の数値は何だと考えられるか．

ヒント：回路上の電圧（0,1）の変化には電気の流れる速さによる時間の遅れがある．

<span style="color:red">解答例</span>

始めに$CLK$の低下により$Q_0$が$1\to0$と変化し，次に$Q_1$が$1\to0$，次に$Q_2$が$1\to0$と変化するため，その過程では$6, 4$を経る．

```

---

## レジスタ

データを一時的に記憶するための回路．

種類
- 汎用レジスタ：算術演算や論理演算の入力や出力結果を一時的に記憶．
- フラグレジスタ：演算結果に関する属性（符号・オーバーフローなど）を記憶．条件分岐などで参照する．
- スタックポインタ：スタック領域を指示．（スタック：データを一時的に詰める場所）
- プログラムカウンタ：次に実行する命令が格納されているアドレスを指示．
- 命令レジスタ：メモリから読み出した現在実行中の命令を記憶．
- メモリアドレスレジスタ：これからアクセスするメモリのアドレスを指示．
- メモリデータレジスタ：メモリからCPUへ流すデータを一時的に記憶．

![演算](/contents/figs/11/computer.png)

※ ALU（Arithmetic and Logic Unit，算術論理演算器）は演算を行う回路．

基本的な4ビットのレジスタは次のように実装される．

![レジスタ回路](/contents/figs/11/register.png)

### シフトレジスタ

- 1クロックごとに**ビットを隣へ転送**．
- ビットを左（高い位）へシフトすれば，2倍したことになる．
- ビットを右（低い位）へシフトすれば，1/2倍したことになる．

→ 乗算器・除算器へ応用

---

## まとめ

- 順序回路の設計は「状態遷移図 → 2進化 → 遷移表 → 論理式 → 実装」の**型**で機械的に進められる．
- フリップフロップを使用して，クロックに応じて値を数える**カウンタ**を実装できる．
- コンピュータ内ではデータを保持する機構が必要であり，この役割を**レジスタ**が担っている．
<!-- - 実回路では**タイミング制約**・**非同期入力**・**ハザード**に注意． -->
<!-- - カウンタは学習効果が高い題材：**非同期**は簡単だが遅延が累積，**同期**は高速・堅牢． -->
<!-- - レジスタ／シフトはデータの受け渡しの基本部品． -->
