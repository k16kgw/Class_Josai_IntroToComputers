# 順序回路の設計法

到達目標
- 順序回路の**設計手順**（状態遷移図→2進コード化→遷移表→論理式）を一通り実施できる．
- 代表的な**回路構成**（FF＋組合せ回路，クロック，リセット）を示せる．
- 実回路で問題となる**タイミング制約**・**メタスタビリティ**・**ハザード**の要点を説明できる．
- **カウンタ（非同期・同期）**と**レジスタ（シフトレジスタ）**の基本構成を設計できる．

今日の問い

- 図で描いた状態機械を，どうやって**ゲートとFF**に落とす？
- なぜ「同期（クロック）」が設計を楽にする？どんな落とし穴がある？
- 非同期カウンタと同期カウンタの違いは何？どちらをいつ使う？

キーワード

- 状態遷移図，二進コード化，状態遷移表
- 次状態方程式，出力方程式，励起表
- セットアップ時間，ホールド時間，クロックスキュー，ジッタ
- 非同期（リップル）カウンタ，同期カウンタ
- レジスタ，SISO/SIPO/PISO/PIPO，シフト

## 順序回路

- **順序回路**：初期状態から始まり，決まった順序で状態遷移を行う機能を実現する回路．
<!-- - **順序回路**：出力が**現在の入力**だけでなく**内部状態**にも依存して決まる回路． -->
  
  <!-- 形式：$Q^+ = f(Q, X)$, $Y = g(Q, X)$（Mealy）／ $Y = g(Q)$（Moore） -->

- **状態遷移図**：状態ノードと，入力条件付きの矢印（次状態）で表す．
<!-- - **設計での選択**：Moore（出力が安定しやすい）／Mealy（状態数が少なくできることが多い）． -->

## 順序回路の設計

1. **状態遷移図の作成**：初期状態と終了状態を含む<u>複数の状態を定義</u>し，次に各状態への入力とそれにより生じる状態遷移と出力を定義する．
2. **2進コード化**：各状態と入出力を表する2進数の値を決め，1で作成した状態遷移図を2進数の値で描き直す．
3. **状態遷移表の作成**：現在の状態から入力により次の状態へ遷移し，出力する様子を状態遷移表にまとめる．
4. **回路化**：状態遷移表に従い，状態遷移図と同様の動作を行う順序回路を，フリップフロップと組合せ回路を用いて設計する．
  <!-- （SOP/POS→K-map/Q-Mで簡略化→NAND/NOR/MUXで実装） -->

### 例：3枚入れるとコーヒーが出る自動販売機
<!-- ### 例1：パターン“01”検出器（出力は1クロックだけ1） -->

1種類の硬貨のみを考え，硬貨を3枚入れるとコーヒーが出てくる自動販売機を実装する．

**Step 1：状態遷移図の作成**

![状態遷移図](/contents/figs/9/state_graph.png)

**Step 2：2進コード化**

- 入力：硬貨を投入する/しない → 1,0
- 出力：コーヒーを出す/出さない → 1,0
- 現在の状態：硬貨の枚数0,1,2枚 → 00,01,10

![2進コード化](/contents/figs/9/bit_graph.png)

**Step 3：状態遷移表の作成**

![状態遷移表](/contents/figs/9/state_table.png)

**Step 4：回路化**

- 入力：硬貨を投入する/しない(1,0) → $S$, 1bit
- 出力：コーヒーを出す/出さない(1,0) → $G$, 1bit
- 現在の状態：硬貨の枚数0,1,2枚(00,01,10) → $C_1, C_0$, 2bit
  ※ 現在の状態は記憶されないといけない．
- 次の状態：硬貨の枚数0,1,2枚(00,01,10) → $N_1, N_0$, 2bit
- 状態の(11)は使用されていないため，ドントケアとして扱える．

- $N_1$のカルノー図は

  ![Karnaugh](/contents/figs/9/Karnaugh_N1.png)

  となるから

  $$
  N_1 = C_1 \cdot \overline{S} + C_0 \cdot S
  $$

```{note}
**演習1**

1. $N_0$のカルノー図を作成し，$N_0$を加法標準形で表せ．
2. $G$のカルノー図を作成し，$G$を加法標準形で表せ．


![Karnaugh](/contents/figs/9/Karnaugh_N0.png)

$$
N_0 = C_0 \cdot \overline{S} + \overline{C_0} \cdot \overline{C_1} \cdot S
$$

![Karnaugh](/contents/figs/9/Karnaugh_G.png)

$$
G = C_1 \cdot S
$$ 

```


4. 回路の設計（論理式の決定）

   - (Q^+) と (Y) を **K-map** や **Q–M法**で簡略化し，**D-FF／JK-FF／T-FF** いずれかで実装する．
   - FFをJK/Tで用いるなら**励起表**で入力式を導出（例：Tは「変えたいとき1」）．

---

### 回路の構成（最小ブロック）

- 記憶：D-FF（一般的），またはJK/T-FF（カウンタ等）を**状態ビット数だけ**用意．
- 組合せ回路：

  - 次状態方程式 (Q^+ = f(Q, X))
  - 出力方程式 (Y = g(Q))（Moore）または (g(Q, X))（Mealy）
- リセット（初期化）：

  - 同期リセット（CLKで反映）／非同期リセット（即反映）．FPGA/ASICで流儀が異なるため**方針を統一**する．
- クロック：

  - 1ドメイン内で配線（スキュー最小化），非同期入力は**2段同期器**で取り込み（第9回復習）．

### 現実の回路における問題点

- タイミング制約
  - コインが投入された(1)のとき，クロックが1でないと投入は判定されない．
  - コインが投入された(1)ときに，クロックが早く1→0→1となると，コインは1度しか投入されていないにも関わらず2度投入された判定をされてしまう．

  <!-- - セットアップ：(T_{clk} \ge t_{CQ}^{max} + t_{comb}^{max} + t_{setup} + \text{skew}^{max})
  - ホールド：(t_{CQ}^{min} + t_{comb}^{min} \ge t_{hold} + \text{skew}^{min})
  - 速すぎても遅すぎても破る．遅延挿入や再配線で調整． -->
- メタスタビリティ

  - 非同期入力をクロック縁でサンプリングすると発生し得る → **FF×2 同期器**で確率低減．
- ハザード

  - 論理最小化で**静的ハザード**が現れることがある → **冗長項の追加**や**同期化**で抑制．
- クロックスキュー／ジッタ

  - スキューは setup/hold マージンに直撃．ツリー設計や配線長・バッファで管理．

---

## カウンタ

### 非同期カウンタ（リップルカウンタ）

- 構成

  - **フリップフロップの出力**を**次段のクロック**に接続（L→HまたはH→Lでトグル）．
  - 例：T-FF を用い (T=1) 固定でトグルさせる．
- 特徴

  - 構成が簡単，ゲートが少ない．
  - ただし**各段で遅延がリップル**し，ビット幅に比例して**グリッチ**と**遅延**が増大．
- 2分周チェーン例（T-FF×n）

  - (Q_0)：入力CLKの1/2，(Q_1)：1/4，…（逓倍器・LED走査などで有用）

```{note}
**演習1（非同期カウンタ）**  
T-FFを3段接続し，入力CLKに対する \(Q_2Q_1Q_0\) の出力列を最初の 8クロック分書け（初期 000）．
```

### 同期カウンタ

- 構成

  - **全FFに同一クロック**を与え，**次状態回路**で同時更新．
- 2ビット上カウントの設計例

  - D-FFで：

    - (D_0=\overline{Q_0})（毎回反転）
    - (D_1=Q_1 \oplus Q_0)（下位が1のとき反転）
  - T-FFで：

    - (T_0=1,\ T_1=Q_0)
- 特徴

  - 遅延は**1サイクル内の組合せ遅延のみ** → 高速・安定．
  - 論理が増える場合あり（ただし小規模では軽微）．

```{tip}
**手を動かす（5分）**  
3ビット同期カウンタ（上カウント）を T-FF で設計：  
\(T_0=1,\ T_1=Q_0,\ T_2=Q_1\cdot Q_0\) を導出してブロック図化．
```

---

## レジスタ

- レジスタ：**並列ビット**の格納要素（D-FFの束）．

  - 入力 (D_{n-1:0}) をクロックで取り込み，出力 (Q_{n-1:0}) として保持．
- クリア／プリセット付き，イネーブル（EN）付き等のバリエーション．

### シフトレジスタ

- 1クロックごとに**ビットを隣へ転送**．用途：シリアル通信，逐次演算，LED制御など．
- 代表4種（入出力の形態）

  - SISO（Serial In Serial Out）：ビット列を直列入出力
  - SIPO（Serial In Parallel Out）：直列で受けて並列に出力（受信バッファ等）
  - PISO（Parallel In Serial Out）：並列で取り込み直列で送出（送信シフト）
  - PIPO（Parallel In Parallel Out）：レジスタとして保持（シフトしない）
- 右シフト（SIPO）構成例（D-FF×n）

  - (D_{i}=Q_{i-1})（(i\ge1)），(D_0=\text{SER_IN})，出力 (Q_{n-1:0})

```{note}
**演習2（シフト）**  
SIPO 4ビットの右シフトレジスタに `SER_IN=1,0,1,1` を順に入力（1クロックごと）．  
各クロック後の \(Q_3Q_2Q_1Q_0\) を初期 0000 から追跡せよ．
```

---

## 例で学ぶ：順序回路の設計（総合ミニ例）

仕様

- 入力 (X) が「連続する 2回の 1」を検出した直後の**次クロック**で (Y=1) を出し，それ以外は 0．（Moore，1クロック幅）

手順

- 状態遷移図

  - (S_0)：未検出，(S_1)：直前 1，(S_2)：検出直後（(Y=1)），次で (S_0)．
- 2進コード化

  - (S_0=00,\ S_1=01,\ S_2=10)（11は未使用）．
- 遷移表（抜粋）

  - (00 \xrightarrow{X=1} 01)，(01 \xrightarrow{X=1} 10)，(10 \xrightarrow{X=*} 00) 他は適宜．
- 論理式（K-mapで簡略化の一例）

  - (Q_1^+ = \overline{Q_1}Q_0X)
  - (Q_0^+ = \overline{Q_1}\overline{X})
  - (Y = Q_1\overline{Q_0})

```{tip}
**設計メモ**  
未使用状態“11”には安全遷移（例：00）を割当てておく．リセットは 00 に向ける．
```

---

## 例題と演習

```{note}
**例題1（設計手順の適用）**  
仕様：「入力Xが“010”を検出したら次クロックでY=1（1クロックだけ）」の Moore 機械を設計せよ：  
1) 状態遷移図 → 2) 2進コード化 → 3) 遷移表 → 4) \(Q^+\), \(Y\) の論理式（K-map簡略化）．
```

**解答例（要点）**

- 状態：(S_0)（なし），(S_1)（直前0），(S_2)（直前01），(S_3)（出力1）
- 符号化例：(S_0=00,S_1=01,S_2=11,S_3=10)（一例）
- (Y=1) は (S_3) のみ（Moore），K-mapで次状態を導出（配布解答に式提示）．

```{note}
**演習3（カウンタ比較・10分）**  
1) 3ビット非同期カウンタで **011→100** へ移る瞬間の各ビットの切替順序を言語化せよ（なぜグリッチが出やすい？）．  
2) 同じ機能を同期カウンタで実装し，ゲート式（T-FF使用）を与えよ（\(T_0=1,\ T_1=Q_0,\ T_2=Q_1Q_0\) をヒントに）．
```

**解答例（要点）**

- 1. 非同期は LSB→MSB の順に遅延を伴い反転するため，一瞬「100」に達する前に「000」「001」等を経由し得る．
- 2. 同期では同一クロックで同時更新するため，内部は論理式どおりに一挙に遷移する．

---

## まとめ

- 順序回路の設計は「状態遷移図 → 2進化 → 遷移表 → 論理式 → 実装」の**型**で機械的に進められる．
- 実回路では**タイミング制約**・**非同期入力**・**ハザード**に注意．
- カウンタは学習効果が高い題材：**非同期**は簡単だが遅延が累積，**同期**は高速・堅牢．
- レジスタ／シフトはデータの受け渡しの基本部品．

---

### 付録：板書用チートシート

- タイミング不等式

  - (T_{clk}\ge t_{CQ}^{max}+t_{comb}^{max}+t_{setup}+\text{skew}^{max})
  - (t_{CQ}^{min}+t_{comb}^{min}\ge t_{hold}+\text{skew}^{min})
- 励起表（抜粋）

  - D：(D=Q^+)
  - T：(T=Q\oplus Q^+)（変える=1）
  - JK：(Q^+=J\overline{Q}+\overline{K}Q)
- シフト4形（SISO/SIPO/PISO/PIPO）
- 同期3ビットカウンタ（T-FF）：(T_0=1,\ T_1=Q_0,\ T_2=Q_1Q_0)

図版（任意パス）

- 状態遷移図テンプレ：`/contents/figs/11/states.png`
- リップル vs 同期カウンタ：`/contents/figs/11/counters.png`
- SIPOシフト：`/contents/figs/11/shift_sipo.png`
