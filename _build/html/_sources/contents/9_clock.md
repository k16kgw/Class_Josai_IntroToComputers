# クロックの役割，同期回路と非同期回路

到達目標
- 記憶の役割を果たすSRフリップフロップを実装できる．
- 順序回路における**クロック**の役割を説明できる．
- **同期回路**と**非同期回路**の違いを，利点・注意点とともに述べられる．
- 状態遷移の考え方を理解する．
<!-- - 状態遷移の考え方を理解し，**順序回路の基本設計手順**（状態遷移図→符号化→遷移表→フリップフロップ＋組合せ回路）を実施できる． -->
<!-- - **セットアップ/ホールド**・**クロック遅延/スキュー/ジッタ**の用語・基本式を扱える． -->
<!-- - 簡単な**同期設計フロー**（次状態方程式→FF→タイミング検証）と**非同期入力の同期化**（2段FF）を示せる． -->

今日の問い
- なぜクロックがあると安全に状態を更新できるのか？
- 同期回路と非同期回路，それぞれのメリットとデメリットは何か？

キーワード
- クロック
- 同期回路，非同期回路
- 状態遷移

---

## 第8回の復習と続き（記憶）

### 電子回路でのNOTゲート・NANDゲートの実装

- 電源（電圧$V+$）を1，アース（電圧$0$）を0と扱う．

NOTゲートは電子回路では次のように実装される．

![NOT回路](/contents/figs/8/not.png)

- 入力が電圧$0$(0)であればトランジスタは上下の導線を通さず，出力は電圧$V+$(1)となる．
- 入力が電圧$V+$(1)であればトランジスタは上下の導線を通し，電源からアースへ電流が流れ，出力は電圧$0$(0)となる．

NANDゲートは電子回路では次のように実装される．

![NAND回路](/contents/figs/8/nand.png)

- 入力A・Bの片方だけでも電圧$0$(0)であればトランジスタは上下の導線を通さず，出力は電圧$V+$(1)となる．
- 入力A・Bの両方が電圧$V+$(1)であればトランジスタは上下の導線を通し，電源からアースへ電流が流れ，出力は電圧$0$(0)となる．

### NOTゲートによる状態の記憶

![NOTゲート](/contents/figs/8/not_memory.png)

- $P=0$のとき，$Q=1$でないと矛盾
- $P=1$のとき，$Q=0$でないと矛盾
- $P=0$であれば$Q=1$が，$P=1$であれば$Q=0$が保持（記憶）される．

### NANDゲートによる状態の記憶

NOTゲートをNANDゲートに置き換え，片方を入力として外に配線すれば次のようになる．

![NANDゲート](/contents/figs/8/nand_memory1.png)

記憶される部分を出力として外に配線すれば次のようになる．

![NANDゲート](/contents/figs/8/nand_memory2.png)

この回路は出力に状態（0 or 1）を記憶でき，この回路を<span style="color:red">フリップフロップ</span>と呼ぶ．

```{note}
**第8回演習2**

1. $A,B$の全ての組み合わせに対して$P,Q$はどの値を取れば良いか考えよ．

| $A$ | $B$ | $P$ | $Q$ |
| :-: | :-: | :-: | :-: |
|  0  |  0  |     |     |
|  0  |  1  |     |     |
|  1  |  0  |     |     |
|  1  |  1  |     |     |
|  1  |  1  |     |     |

※ $(A,B)=(1,1)$のときは2通りの可能性がある．

2. 入力の値が$(A,B)=(0,1)$から$(1,1)$に変わったとき，出力$(P,Q)$の値はどうなるか．

3. 入力の値が$(A,B)=(0,0)$から$(1,1)$に変わったとき，出力$(P,Q)$の値はどうなると予想されるか．
<!-- 
**解答例**

| $A$ | $B$ | $P$ | $Q$ |
| :-: | :-: | :-: | :-: |
|  0  |  0  |  1  |  1  |
|  0  |  1  |  1  |  0  |
|  1  |  0  |  0  |  1  |
|  1  |  1  |  1  |  0  |
|  1  |  1  |  0  |  1  |

※ $(A,B)=(1,1)$のときは2通りの可能性がある．

$(A,B)=(1,1)$のとき，前の$(P,Q)$の状態が$(0,1)$であれば$(0,1)$を，$(1,0)$であれば$(1,0)$を保持する．

現実的に$(A,B)=(0,0)$から$(1,1)$に変わるのに，$A$と$B$を厳密に同時に$1$に変えることは難しい．
どちらかが先に$1$になるため，結局前の$(P,Q)$の状態は$(0,1)$か$(1,0)$のどちらかとなる．
 -->
```

---

## SRフリップフロップ

NANDゲートを使用した記憶の回路を実装する場合には，次のようにNOTゲートを挟んで実装する．
この回路を<span style="color:red">SRフリップフロップ</span>と呼ぶ．
ここでは出力は$Q$とその否定$\overline{Q}$のみであるとする．

![SRflipflop](/contents/figs/8/SRflipflop.png)

```{note}
**演習1**

SRフリップフロップではNOTゲートを挟むことで状態を記憶する入力を$(S,R)=(0,0)$とする．
NOTゲートを挟まない場合の$(S,R)=(1,1)$を記憶する入力しないのはなぜだと思うか．

ヒント：0は電圧が低いことに，1は電圧が高いことに対応している．
```

### 状態遷移

記憶を考えることで，状態の時間変化を考慮する必要が生じる．
そこで状態$Q$が入力に対してどのように変化するか，次の状態$Q'$の値を調べる．
これを次のように<span style="color:red">状態遷移表</span>として考える．

![状態遷移](/contents/figs/9/state_shift.png)

$S=1$とすれば**セット**(set)され，$R=1$とすれば**リセット**(reset)される．

---

## クロック

- **同期**：様々な作業の相対的な順番を決めて手続きを実行する必要があり，この順番を決めることを「**同期を取る**」と呼ぶ．
  - 作業の順番が回ってくるまでデータを記憶しておく必要があり，これにフリップフロップのような回路を使用する．

- **クロック**：同期を取るための合図となるもの．回路全体の**時間のものさし**であり，一定周期で規則的に0と1を繰り返すことで実現される．
  - 周期の逆数である**周波数**が単位時間あたりの0・1の繰り返しの回数を表し，クロック数を表現する量として使用される．
  - 1周期$T$[秒]／周波数 $f=\frac{1}{T}$[Hz]
  - $f$が高いほど**1サイクルが短く高性能**だが，タイミング制約が厳しい．

  ![クロック](/contents/figs/9/clock.png)

<!-- - 役割：各フリップフロップが**同じタイミング**で入力を観測 → ばらつくゲート遅延の影響を**クロック境界で区切る**． -->
<!-- - 角周波数 $\omega=2\pi f$[rad/s] -->
<!-- - デューティ比（High比率），**ジッタ**（周期の揺れ），**スキュー**（配線差での到達時刻差） -->
<!-- - **可変周波数**：実CPUは状況により周波数と電圧を変える（省電力・熱設計）．
固定の1値ではなく，**ベースクロック／ブースト**などの概念で把握する． -->

### 同期回路と非同期回路

- **同期回路**：クロックに同期して動作する回路．
- **非同期回路**：クロックの動作に縛られず，入力信号の伝達に任せて出力信号が決まる回路．
<!-- - 実チップのゲート・配線遅延は**ばらつく**．同期がないと，**競合（レース）**・**グリッチ**が出やすい． -->
<!-- - クロックで**観測の瞬間**を決めるから，多少の遅延差があっても**同時刻の安定値**で動作できる． -->
<!-- 
- 基本のタイミング不等式：

  - 最大遅延（セットアップ）

    $$
    T_{clk} \ge t_{CQ}^{max} + t_{comb}^{max} + t_{setup} + \text{skew}^{max}
    $$

  - 最小遅延（ホールド）
    $$
    t_{CQ}^{min} + t_{comb}^{min} \ge t_{hold} + \text{skew}^{min}
    $$
 -->

<!-- - **同期回路**：共通のクロックで**状態更新**を行う．設計・検証が容易． -->
  
  <!-- 例：CPUのパイプライン，同期式カウンタ，ほぼ全てのSoCの基本． -->

<!-- - **非同期回路**：クロックを用いず，**イベント**や**ハンドシェイク**で動作． -->

  <!-- 例：ボタン入力，異なるクロック領域間のFIFO，低消費電力ロジックの一部． -->

**メリットとデメリット**

| 種類       | メリット               | デメリット                               |
| -----     | --------------------- | -------------------------------        |
| 同期回路   | 動作が安定しやすい．      | クロックを待つ時間だけ動作が遅くなる．       |
| 非同期回路 | 高速に動作する．         | タイミングによっては動作が不安定になりやすい． |

<!-- - **非同期入力の扱い**：2段FF同期器／デバウンス（機械スイッチ）／パルスストレッチ等． -->

### 同期付きSRフリップフロップ回路

- クロック（$\mathrm{CLK}$）が1のときのみ入力を許可する．
  - $\mathrm{CLK}=1$のとき，$S=0$なら$0$を，$S=1$なら$1$とする．（$R$も同様）
  - $\mathrm{CLK}=0$のとき，$S,R$の値によらず$0$とする．
- 従って$\mathrm{CLK}$と$S,R$をANDで接続すれば良い．

![クロックSRフリップフロップ](/contents/figs/9/clockSRflipflop.png)

これはNANDゲートに置き換えることができる．

![クロックSRフリップフロップ](/contents/figs/9/clockSRflipflop_NAND.png)

---

## 順序回路

- **順序回路**：初期状態から始まり，決まった順序で状態遷移を行う機能を実現する回路．
<!-- - **順序回路**：出力が**現在の入力**だけでなく**内部状態**にも依存して決まる回路． -->
  
  <!-- 形式：$Q^+ = f(Q, X)$, $Y = g(Q, X)$（Mealy）／ $Y = g(Q)$（Moore） -->

- **状態遷移図**：状態ノードと，入力条件付きの矢印（次状態）で表す．
<!-- - **設計での選択**：Moore（出力が安定しやすい）／Mealy（状態数が少なくできることが多い）． -->

## 順序回路の設計

1. **状態遷移図の作成**：初期状態と終了状態を含む<u>複数の状態を定義</u>し，次に各状態への入力とそれにより生じる状態遷移と出力を定義する．
2. **2進コード化**：各状態と入出力を表する2進数の値を決め，1で作成した状態遷移図を2進数の値で描き直す．
3. **状態遷移表の作成**：現在の状態から入力により次の状態へ遷移し，出力する様子を状態遷移表にまとめる．
4. **回路化**：状態遷移表に従い，状態遷移図と同様の動作を行う順序回路を，フリップフロップと組合せ回路を用いて設計する．
  <!-- （SOP/POS→K-map/Q-Mで簡略化→NAND/NOR/MUXで実装） -->

### 例：3枚入れるとコーヒーが出る自動販売機
<!-- ### 例1：パターン“01”検出器（出力は1クロックだけ1） -->

1種類の硬貨のみを考え，硬貨を3枚入れるとコーヒーが出てくる自動販売機を実装する．

**Step 1：状態遷移図の作成**

![状態遷移図](/contents/figs/9/state_graph.png)

**Step 2：2進コード化**

- 入力：硬貨を投入する/しない → 1,0
- 出力：コーヒーを出す/出さない → 1,0
- 現在の状態：硬貨の枚数0,1,2枚 → 00,01,10

![2進コード化](/contents/figs/9/bit_graph.png)

**Step 3：状態遷移表の作成**

![状態遷移表](/contents/figs/9/state_table.png)

**Step 4：回路化**

- 入力：硬貨を投入する/しない(1,0) → $S$, 1bit
- 出力：コーヒーを出す/出さない(1,0) → $G$, 1bit
- 現在の状態：硬貨の枚数0,1,2枚(00,01,10) → $C_1, C_0$, 2bit
  ※ 現在の状態は記憶されないといけない．
- 次の状態：硬貨の枚数0,1,2枚(00,01,10) → $N_1, N_0$, 2bit
- 状態の(11)は使用されていないため，ドントケアとして扱える．

- $N_1$のカルノー図は

  ![Karnaugh](/contents/figs/9/Karnaugh_N1.png)

  となるから

  $$
  N_1 = C_1 \cdot \overline{S} + C_0 \cdot S
  $$

```{note}
**演習2**

1. $N_0$のカルノー図を作成し，$N_0$を加法標準形で表せ．
2. $G$のカルノー図を作成し，$G$を加法標準形で表せ．

<!-- 
![Karnaugh](/contents/figs/9/Karnaugh_N0.png)

$$
N_0 = C_0 \cdot \overline{S} + \overline{C_0} \cdot \overline{C_1} \cdot S
$$

![Karnaugh](/contents/figs/9/Karnaugh_G.png)

$$
G = C_1 \cdot S
$$
 -->
```

この後の回路の構成には「Dフリップフロップ」を使用するため，第11回に続きを解説する．

<!-- 
- 入力：$X$（1ビット），出力：$Y$
- 仕様：直前の2ビットが“01”なら次クロックで $Y=1$（以降は0）
- **状態遷移図（Moore）**

  - $S_0$：何も検出していない
  - $S_1$：直前が0
  - $S_2$：“01”検出直後（出力1），次で必ず $S_0$
  - 遷移：

    - $S_0 \xrightarrow{X=0} S_1,\quad S_0 \xrightarrow{X=1} S_0$
    - $S_1 \xrightarrow{X=0} S_1,\quad S_1 \xrightarrow{X=1} S_2$
    - $S_2 \xrightarrow{X=*} S_0$
- **2. 二進コード化**（2ビット状態）

  - $S_0=00,\ S_1=01,\ S_2=10$（11は未使用）
- **3. 状態遷移表**（現状態 $Q_1Q_0$, 入力 $X$ → 次状態 $Q_1^+Q_0^+$, 出力 $Y$）

| (Q_1Q_0) | (X) | (Q_1^+Q_0^+) | (Y) |
| :------: | :-: | :----------: | :-: |
|    00    |  0  |      01      |  0  |
|    00    |  1  |      00      |  0  |
|    01    |  0  |      01      |  0  |
|    01    |  1  |      10      |  0  |
|    10    |  0  |      00      |  1  |
|    10    |  1  |      00      |  1  |

- **4. 次状態方程式・出力方程式（K-mapで簡略化）**

  - $Q_1^+ = \overline{Q_1},Q_0,X$
  - $Q_0^+ = \overline{Q_1},\overline{Q_0},\overline{X} + \overline{Q_1},Q_0,\overline{X}$
    $\ \Rightarrow\ Q_0^+ = \overline{Q_1},\overline{X}$
  - $Y = Q_1\ \overline{Q_0}$（= 状態 (10) のときのみ1）
- **回路化**

  - D-FF×2で $Q_1,Q_0$ を格納
  - $D_1 = Q_1^+,\ D_0 = Q_0^+$ を与える組合せ回路を実装
  - 出力 $Y$ は $Q_1$ と $\overline{Q_0}$ のAND

```{tip}
**設計メモ**
- 未使用状態“11”には**安全遷移**を割り当て（例えば S0=00）ると，リセット後の安全性が増す．
```

---

```{note}
**演習1**  

D-FFのパス：FF1 → 組合せ回路($t_{comb}^{max}=1.8\text{ns}$) → FF2．  
$t_{CQ}^{max}=120\text{ps},\ t_{setup}=80\text{ps},\ \text{skew}^{max}=100\text{ps}$．  
満たすべき最小クロック周期 $T_{clk}^{min}$ と最大クロック周波数 $f_{max}$ を求めよ．
```

**解答例**
$T_{clk}^{min}=0.12+1.8+0.08+0.10=2.10\text{ns}$ → $f_{max}\approx 476\text{MHz}$．

```{note}
**演習2**  

非同期ボタン入力を2段FFで同期化し，1クロック幅の立上りパルスを生成せよ．  
```

**解答例（要点）**

- FF1: (D=BTN\to Q=SYNC1)，FF2: (D=SYNC1\to Q=SYNC2)（同一クロック）
- パルス：(PULSE = SYNC2 \cdot \overline{SYNC2_{prev}})（前サイクル値との差分）

```{note}
**演習3（設計・25分）**  
次の仕様の**Mealy機械**を設計せよ（最小状態でOK）．  
「入力 \(X\) が “011” と連続で現れた瞬間に \(Y=1\) を出し，それ以外は0」  
手順：1) 状態遷移図 → 2) 二進コード化 → 3) 遷移表 → 4) 次状態・出力方程式 → 5) D-FF実装．
```

**解答例（概略）**

- 状態語：S0（なし），S1（直前0），S2（直前01）．Mealyなので S2 で (X=1) 見た瞬間 (Y=1)．
- 符号化例：S0=00, S1=01, S2=10．
- 次状態・出力式（要約）：

  - $Q_1^+ = \overline{Q_1}Q_0X + \overline{Q_1}\overline{Q_0}\overline{X}$（一例）
  - $Q_0^+ = \overline{Q_1}\overline{Q_0}X + \overline{Q_1}Q_0\overline{X}$（一例）
  - $Y = \overline{Q_1}Q_0X$（S2到達直前の遷移で1を出す形）
    ※ 実際はK-mapで簡略化して提示．状態割当が違っても同価なら可．
 -->
---

## まとめ

```{note}
**復習**

次の問いに対する自分なりの答えを述べよ．
1. なぜクロックがあると安全に状態を更新できるのか？
2. 同期回路と非同期回路，それぞれのメリットとデメリットは何か？
```
